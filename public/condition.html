<!doctype html>
<html lang="th">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" />
  <title>ยินยอมการใช้ข้อมูล (PDPA) | DoctorNoo</title>

  <!-- LIFF SDK -->
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Thai:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <script>
    tailwind.config = {
      theme: {
        extend: {
          fontFamily: { sans: ['"Noto Sans Thai"', 'sans-serif'] },
          colors: {
            tealMain: "#0D9488",
            tealDark: "#0F766E",
            coral: "#FF9B85",
            cream: "#FFF8F0",
            card: "#FFFFFF",
            textMain: "#134E4A",
            textSub: "#64748B",
            stroke: "#E2E8F0"
          },
          boxShadow: {
            soft: "0 10px 40px -10px rgba(13, 148, 136, 0.15)"
          }
        }
      }
    }
  </script>

  <style>
    body {
      background-color: #FFF8F0;
      overscroll-behavior: none;
      -webkit-font-smoothing: antialiased;
      font-family: "Noto Sans Thai", sans-serif;
    }
    .custom-scrollbar::-webkit-scrollbar { width: 4px; }
    .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #CBD5E1; border-radius: 20px; }

    .ck input:checked + .box {
      border-color: #0D9488;
      background-color: #F0FDFA;
    }
    .ck input:checked + .box .tick { opacity: 1; transform: scale(1); }
    .ck input:checked + .box .ring {
      border-color: #0D9488;
      background-color: #0D9488;
    }
  </style>
</head>

<body class="font-sans text-textMain h-screen w-screen overflow-hidden flex items-center justify-center bg-cream sm:p-6">

  <div class="w-full h-full sm:h-[85vh] sm:max-w-md sm:rounded-[24px] bg-card flex flex-col shadow-soft relative overflow-hidden">

    <!-- Header -->
    <header class="relative px-6 pt-8 pb-8 text-white shrink-0"
      style="background: linear-gradient(135deg, #0D9488 0%, #115E59 100%);">

      <div class="flex items-center gap-4 relative z-10">
        <div class="w-12 h-12 rounded-2xl bg-white/10 backdrop-blur-sm border border-white/20 flex items-center justify-center shrink-0">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor"
               stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="text-coral">
            <path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/>
          </svg>
        </div>

        <div>
          <h1 class="text-2xl font-bold leading-none tracking-wide">ยินยอมข้อมูลส่วนบุคคล</h1>
          <p class="text-teal-100 text-sm font-medium opacity-90 mt-1">PDPA ก่อนเริ่มทำแบบประเมิน</p>
        </div>
      </div>

      <div class="absolute -right-6 -top-12 w-40 h-40 bg-white/5 rounded-full blur-3xl pointer-events-none"></div>
      <div class="absolute bottom-0 right-0 w-full h-px bg-gradient-to-r from-transparent via-white/20 to-transparent"></div>
    </header>

    <!-- Content -->
    <main class="flex-1 overflow-y-auto custom-scrollbar px-6 py-6 bg-white relative">

      <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-lg bg-cream text-tealMain text-xs font-bold mb-4 border border-tealMain/10">
        <svg class="w-3.5 h-3.5" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect>
          <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
        </svg>
        โปรดอ่านและยินยอมก่อนเริ่มทำแบบประเมิน
      </div>

      <h2 class="text-xl font-bold text-tealDark leading-snug mb-2">
        การยินยอมใช้ข้อมูล (PDPA)
      </h2>

      <!-- LINE User Preview (จะโชว์เมื่อได้ profile จาก LIFF) -->
      <div id="lineUserBox" class="mt-3 hidden rounded-2xl border border-stroke bg-white p-4">
        <div class="flex items-center gap-3">
          <img id="lineUserPic" class="w-12 h-12 rounded-full object-cover border border-stroke" alt="LINE profile" />
          <div class="flex-1">
            <div class="text-sm font-bold text-textMain">
              สวัสดี <span id="lineUserName">-</span>
            </div>
            <div class="text-[11px] text-textSub break-all">
              LINE userId: <span id="lineUserId">-</span>
            </div>
          </div>
          <span class="text-[10px] font-bold px-2 py-1 rounded-lg bg-[#F0FDFA] text-tealDark border border-tealMain/20">
            เชื่อม LINE แล้ว
          </span>
        </div>
      </div>

      <div id="lineUserHint" class="mt-3 rounded-2xl border border-orange-100 bg-orange-50 p-4 text-xs text-orange-800">
        * ถ้าเปิดผ่าน LINE (LIFF) ระบบจะแสดงชื่อและโปรไฟล์ตรงนี้เพื่อยืนยันตัวตน
      </div>

      <div class="space-y-4 text-sm text-textSub leading-relaxed mt-4">

        <p class="text-textMain">
          การกด <span class="font-bold text-tealMain">“ยอมรับ”</span>
          หมายความว่าท่านยินยอมให้แพทย์และทีมงาน เก็บ รวบรวม ใช้ และเปิดเผยข้อมูลส่วนบุคคลของท่าน
          รวมถึงข้อมูลสุขภาพที่ท่านให้ผ่านเว็บไซต์หรือ LINE OA
        </p>

        <div class="rounded-xl border border-tealMain/20 bg-[#F0FDFA] p-4">
          <p class="text-xs font-bold text-tealMain mb-2 uppercase tracking-wide">เพื่อวัตถุประสงค์:</p>
          <ul class="space-y-1.5 text-tealDark text-sm">
            <li class="flex items-start gap-2">
              <span class="w-1.5 h-1.5 rounded-full bg-tealMain mt-1.5 shrink-0"></span>
              <span>ให้คำแนะนำ และประเมินข้อมูลเบื้องต้น</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="w-1.5 h-1.5 rounded-full bg-tealMain mt-1.5 shrink-0"></span>
              <span>ติดต่อ นัดหมาย และให้บริการทางการแพทย์</span>
            </li>
            <li class="flex items-start gap-2">
              <span class="w-1.5 h-1.5 rounded-full bg-tealMain mt-1.5 shrink-0"></span>
              <span>พัฒนาคุณภาพบริการ</span>
            </li>
          </ul>
        </div>

        <p class="text-xs leading-5">
          ข้อมูลจะถูกเก็บรักษาอย่างเหมาะสม <b class="text-tealDark">ไม่ขายหรือเผยแพร่แก่บุคคลภายนอก</b>
          เว้นแต่ได้รับความยินยอมจากท่าน จำเป็นต่อการรักษา หรือเป็นไปตามกฎหมาย
          โดยจะเก็บข้อมูลไว้ <span class="text-coral font-bold">ไม่เกิน 5 ปี</span>
          นับจากวันที่รับบริการครั้งสุดท้าย
        </p>

        <p class="text-xs">
          * ท่านสามารถขอเข้าถึง แก้ไข หรือถอนความยินยอมได้ภายหลัง
        </p>

        <div class="flex gap-3 p-3 bg-orange-50 border border-orange-100 rounded-xl items-start">
          <svg class="w-5 h-5 text-orange-400 shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
            <path stroke-linecap="round" stroke-linejoin="round"
              d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
          </svg>
          <p class="text-xs text-orange-800 font-medium leading-relaxed">
            ทั้งนี้ ข้อมูลหรือการประเมินผ่านระบบนี้ <br>ไม่ถือเป็นการวินิจฉัยแทนการพบแพทย์โดยตรง
          </p>
        </div>

      </div>

      <div class="mt-6 space-y-4">

        <!-- REQUIRED -->
        <label class="ck block cursor-pointer group select-none">
          <input id="ckRequired" type="checkbox" class="hidden" />
          <div class="box rounded-2xl border border-stroke bg-white p-4 transition-all duration-200 hover:border-tealMain/50 active:scale-[0.98]">
            <div class="flex gap-3">
              <div class="ring w-6 h-6 rounded-full border-2 border-slate-300 bg-white flex items-center justify-center shrink-0 transition-colors duration-200">
                <svg class="tick w-3.5 h-3.5 text-white opacity-0 transform scale-50 transition-all duration-200"
                     viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 6L9 17l-5-5"/>
                </svg>
              </div>
              <div class="flex-1">
                <p class="text-sm font-bold text-tealDark">ข้าพเจ้าได้อ่านและยอมรับข้อตกลง</p>
                <div class="flex items-center gap-2 mt-1">
                  <span class="text-[10px] bg-coral/10 text-coral px-1.5 py-0.5 rounded font-medium">จำเป็น (Required)</span>
                </div>
              </div>
            </div>
          </div>
        </label>

        <!-- OPTIONAL -->
        <label class="ck block cursor-pointer group select-none">
          <input id="ckMarketing" type="checkbox" class="hidden" />
          <div class="box rounded-2xl border border-stroke bg-white p-4 transition-all duration-200 hover:border-tealMain/50 active:scale-[0.98]">
            <div class="flex gap-3">
              <div class="ring w-6 h-6 rounded-full border-2 border-slate-300 bg-white flex items-center justify-center shrink-0 transition-colors duration-200">
                <svg class="tick w-3.5 h-3.5 text-white opacity-0 transform scale-50 transition-all duration-200"
                     viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M20 6L9 17l-5-5"/>
                </svg>
              </div>
              <div>
                <p class="text-sm font-semibold text-textMain">รับข่าวสารและสิทธิพิเศษ (Optional)</p>
                <p class="text-[11px] text-textSub mt-0.5">แจ้งเตือนเคล็ดลับสุขภาพและโปรโมชั่น</p>
              </div>
            </div>
          </div>
        </label>

      </div>

      <p id="msgTerms" class="mt-6 text-xs text-coral text-center opacity-0 transition-opacity duration-300 font-medium bg-coral/5 py-2 rounded-lg border border-coral/20">
        ⚠️ กรุณายอมรับเงื่อนไขเพื่อดำเนินการต่อ
      </p>

      <div class="h-8"></div>
    </main>

    <!-- Footer -->
    <footer class="px-6 py-5 bg-white border-t border-stroke flex items-center justify-between shrink-0">
      <button id="btnBack" class="text-textSub font-medium flex items-center gap-2 px-2 py-2 rounded-lg hover:bg-slate-50 transition-colors opacity-50 cursor-not-allowed" disabled>
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M19 12H5M12 19l-7-7 7-7"/>
        </svg>
        <span>ปิด</span>
      </button>

      <button id="btnContinue"
        class="group relative px-8 py-3 rounded-xl bg-slate-100 text-slate-400 font-bold shadow-none cursor-not-allowed transition-all duration-300 flex items-center gap-3 overflow-hidden"
        disabled>
        <span class="relative z-10">ยอมรับ</span>
        <svg class="relative z-10 w-5 h-5 transition-transform group-hover:translate-x-1" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M5 12h14M12 5l7 7-7 7"/>
        </svg>
      </button>
    </footer>

  </div>

  <script>
  document.addEventListener("DOMContentLoaded", async () => {
    const LIFF_ID = "2008828976-6MQxt04H";
    const REDIRECT_PAGE = "FertilityCheck.html";
    const CONSENT_VERSION = "PDPA_HEALTH_v2_2026-01-26";
    const SESSION_MINUTES = 30;

    // ✅ ถ้า API อยู่เครื่อง/โดเมนเดียวกันให้ใช้ origin นี้
    // ถ้า API อยู่คนละโดเมน/พอร์ต ค่อยแก้เป็น https://xxxx.ngrok-free.app
    const API_BASE = window.location.origin;

    const $ = (id) => document.getElementById(id);
    const ckRequired = $("ckRequired");
    const ckMarketing = $("ckMarketing");
    const btnContinue = $("btnContinue");
    const msgTerms = $("msgTerms");
    const btnBack = $("btnBack");

    // LINE UI elements
    const lineUserBox = $("lineUserBox");
    const lineUserPic = $("lineUserPic");
    const lineUserName = $("lineUserName");
    const lineUserIdEl = $("lineUserId");
    const lineUserHint = $("lineUserHint");

    let lineUserId = "";

    // --------------------------
    // Session Guard (30 นาที)
    // --------------------------
    function clearPdpaSession() {
      sessionStorage.removeItem("pdpa_required");
      sessionStorage.removeItem("pdpa_marketing");
      sessionStorage.removeItem("consent_version");
      sessionStorage.removeItem("pdpa_accepted_at");
      sessionStorage.removeItem("pdpa_expires_at");
      sessionStorage.removeItem("consent_session_id");
      sessionStorage.removeItem("line_user_id");
    }

    function isPdpaSessionValid() {
      const required = sessionStorage.getItem("pdpa_required") === "1";
      if (!required) return false;

      const exp = Number(sessionStorage.getItem("pdpa_expires_at") || "0");
      if (!exp) return false;

      return Date.now() < exp;
    }

    if (isPdpaSessionValid()) {
      location.replace(REDIRECT_PAGE);
      return;
    } else {
      clearPdpaSession();
    }

    // --------------------------
    // Prevent Back
    // --------------------------
    history.replaceState({ page: "condition" }, "", location.href);
    window.addEventListener("popstate", () => {
      history.pushState({ page: "condition" }, "", location.href);
    });

    // --------------------------
    // UI: enable/disable button
    // --------------------------
    function renderContinue() {
      if (ckRequired.checked) {
        btnContinue.disabled = false;
        btnContinue.classList.remove("bg-slate-100", "text-slate-400", "cursor-not-allowed", "shadow-none");
        btnContinue.classList.add("bg-tealMain", "text-white", "shadow-lg", "shadow-tealMain/30", "active:scale-95");
        msgTerms.style.opacity = "0";
      } else {
        btnContinue.disabled = true;
        btnContinue.classList.remove("bg-tealMain", "text-white", "shadow-lg", "shadow-tealMain/30", "active:scale-95");
        btnContinue.classList.add("bg-slate-100", "text-slate-400", "cursor-not-allowed", "shadow-none");
      }
    }

    // --------------------------
    // LIFF init + show profile
    // --------------------------
    async function initLiff() {
      try {
        if (typeof liff === "undefined") return;

        await liff.init({ liffId: LIFF_ID, withLoginOnExternalBrowser: true });

        // ถ้าเปิดนอก LINE และยังไม่ login -> login แล้วกลับมาหน้านี้
        if (!liff.isLoggedIn()) {
          // ถ้าไม่อยาก redirect ไป login ให้คอมเมนต์บรรทัดนี้
          liff.login({ redirectUri: window.location.href });
          return;
        }

        const profile = await liff.getProfile();
        lineUserId = profile.userId || "";

        // ✅ show on screen
        if (lineUserId) {
          if (lineUserBox) lineUserBox.classList.remove("hidden");
          if (lineUserName) lineUserName.textContent = profile.displayName || "LINE User";
          if (lineUserIdEl) lineUserIdEl.textContent = lineUserId;
          if (lineUserPic) lineUserPic.src = profile.pictureUrl || "https://placehold.co/96x96";
          if (lineUserHint) lineUserHint.classList.add("hidden");
        }

        // Enable close button if in LIFF client
        if (liff.isInClient()) {
          btnBack.disabled = false;
          btnBack.classList.remove("opacity-50", "cursor-not-allowed");
          btnBack.addEventListener("click", () => liff.closeWindow());
        }
      } catch (e) {
        console.log("LIFF init failed", e);
      }
    }

    // --------------------------
    // Helpers
    // --------------------------
    function genUUID() {
      if (window.crypto?.randomUUID) return crypto.randomUUID();
      return "xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g, c => {
        const r = Math.random() * 16 | 0;
        const v = c === "x" ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }

    async function postConsentToDB(payload) {
      const url = `${API_BASE}/api/pdpa/consent`;
      const res = await fetch(url, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(payload),
      });

      if (!res.ok) {
        const text = await res.text().catch(() => "");
        throw new Error(`HTTP ${res.status} ${res.statusText}\n${text}`);
      }

      const contentType = res.headers.get("content-type") || "";
      if (!contentType.includes("application/json")) {
        const text = await res.text().catch(() => "");
        throw new Error(`Response not JSON\n${text}`);
      }

      return res.json();
    }

    // --------------------------
    // Accept -> save DB -> set session -> redirect
    // --------------------------
    async function goNext() {
      if (!ckRequired.checked) {
        msgTerms.style.opacity = "1";
        return;
      }

      // กันกดรัว
      btnContinue.disabled = true;
      btnContinue.classList.add("opacity-80");

      const acceptedAt = new Date();
      const expiresAt = new Date(Date.now() + SESSION_MINUTES * 60 * 1000);
      const consentSessionId = genUUID();

      const payload = {
        wp_user_id: null,
        line_user_id: lineUserId || null,
        consent_session_id: consentSessionId,
        consent_version: CONSENT_VERSION,
        required_consent: 1,
        marketing_consent: ckMarketing.checked ? 1 : 0,
        accepted_at: acceptedAt.toISOString(),
        expires_at: expiresAt.toISOString(),
        source_channel: (typeof liff !== "undefined" && liff.isInClient()) ? "LIFF" : "WEB",
        page_path: "/condition.html",
      };

      try {
        console.log("POST consent payload:", payload);
        console.log("API_BASE:", API_BASE);
        await postConsentToDB(payload);
      } catch (e) {
        console.log("Save consent error:", e);
        alert(
          "บันทึกการยินยอมไม่สำเร็จ\n\n" +
          "รายละเอียด:\n" + (e?.message || e)
        );
        btnContinue.disabled = false;
        btnContinue.classList.remove("opacity-80");
        return;
      }

      // set sessionStorage
      sessionStorage.setItem("pdpa_required", "1");
      sessionStorage.setItem("pdpa_marketing", ckMarketing.checked ? "1" : "0");
      sessionStorage.setItem("consent_version", CONSENT_VERSION);
      sessionStorage.setItem("pdpa_accepted_at", acceptedAt.toISOString());
      sessionStorage.setItem("pdpa_expires_at", String(expiresAt.getTime()));
      sessionStorage.setItem("consent_session_id", consentSessionId);
      if (lineUserId) sessionStorage.setItem("line_user_id", lineUserId);

      location.replace(`${REDIRECT_PAGE}?t=${Date.now()}`);
    }

    ckRequired.addEventListener("change", renderContinue);
    btnContinue.addEventListener("click", goNext);

    renderContinue();
    initLiff();
  });
  </script>

</body>
</html>
